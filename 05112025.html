<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecionar Texto com Tradu√ß√£o Autom√°tica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .text-content {
            font-size: 20px;
            margin-bottom: 20px;
            user-select: text;
            line-height: 1.8;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
        }
        
        .highlighted {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #ffeaa7;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .highlighted:hover {
            background-color: #ffeaa7;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .highlighted.saved-phrase {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .highlighted.saved-word {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .instructions {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.95rem;
            border-left: 4px solid #3498db;
        }
        
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid;
        }
        
        .legend-phrase {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .legend-word {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .floating-button {
            position: fixed;
            display: none;
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }
        
        .translation-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            max-width: 550px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-title {
            font-weight: bold;
            font-size: 20px;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }
        
        .close-button:hover {
            transform: scale(1.2);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        .full-translation {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2ecc71;
        }
        
        .translation-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .word-translations {
            margin-top: 15px;
        }
        
        .word-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
        }
        
        .word-item:last-child {
            border-bottom: none;
        }
        
        .original-word {
            font-weight: bold;
            color: #2c3e50;
            flex: 1;
        }
        
        .translated-word {
            color: #27ae60;
            flex: 1;
        }
        
        .word-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #7f8c8d;
            transition: all 0.2s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .action-button:hover {
            color: #3498db;
            background-color: #f1f8ff;
        }
        
        .phrase-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .language-info {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .language-info span {
            background-color: #ecf0f1;
            padding: 3px 10px;
            border-radius: 15px;
            margin: 0 5px;
        }
        
        .debug-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #856404;
        }
        
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .error {
            color: #e74c3c;
            font-style: italic;
        }
        
        .link-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            width: 90%;
            max-width: 400px;
        }
        
        .link-modal h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .link-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .link-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .text-content {
                font-size: 18px;
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .word-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .word-actions {
                margin-top: 5px;
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <h1>Selecionar Texto com Tradu√ß√£o Autom√°tica</h1>
    <p class="subtitle">Tradu√ß√µes em tempo real usando API do navegador</p>
    
    <div class="container">
        <div class="text-content" id="textContent">
            Carregando texto do Firebase...
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-phrase"></div>
                <span>Frases salvas</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-word"></div>
                <span>Palavras salvas</span>
            </div>
        </div>
        
        <div class="instructions">
            <p><strong>Como usar:</strong> Selecione qualquer palavra ou frase no texto acima. Um bot√£o "Traduzir" aparecer√°. Clique nele para ver a tradu√ß√£o completa e detalhada.</p>
            <p><strong>Recursos:</strong> Use os √≠cones para ouvir a pron√∫ncia, gerenciar salvamento no Anki ou gerenciar links.</p>
            <p><strong>Salvamento:</strong> üíæ = Salvar no Anki | üíø = J√° salvo no Anki</p>
            <p><strong>Links:</strong> üìö = Link cadastrado (clique para abrir) | ‚öì = Cadastrar link</p>
        </div>
        
        <div class="debug-info">
            <p><strong>Recursos Adicionados:</strong></p>
            <ul>
                <li>üéß √çcone de alto-falante para ouvir a pron√∫ncia</li>
                <li>üíæ √çcone de disquete para salvar no Anki</li>
                <li>üíø √çcone de CD para item j√° salvo no Anki</li>
                <li>üìö √çcone de livro para abrir link cadastrado</li>
                <li>‚öì √çcone de √¢ncora para cadastrar novo link</li>
                <li>üìù Salvamento diferenciado: frases ‚Üí "frases", palavras ‚Üí "palavras"</li>
                <li>üü¢ Destaque inteligente sem sobreposi√ß√£o</li>
                <li>üåê Tradu√ß√£o autom√°tica por API</li>
            </ul>
        </div>
        
        <div class="language-info">
            <span>Franc√™s</span> ‚Üí <span>Portugu√™s</span>
        </div>
    </div>
    
    <button class="floating-button" id="translateBtn">Traduzir</button>
    
    <div class="translation-modal" id="translationModal">
        <div class="modal-header">
            <div class="modal-title">Tradu√ß√£o Detalhada</div>
            <button class="close-button" id="closeModal">&times;</button>
        </div>
        <div class="modal-content">
            <div class="full-translation">
                <div class="translation-title">Tradu√ß√£o da Frase</div>
                <div id="fullTranslationText"></div>
                <div class="phrase-actions" id="phraseActions"></div>
            </div>
            
            <div class="word-translations">
                <div class="translation-title">Tradu√ß√µes Individuais</div>
                <div id="wordTranslations"></div>
            </div>
        </div>
    </div>
    
    <div class="link-modal" id="linkModal">
        <h3>Adicionar Link</h3>
        <input type="text" class="link-input" id="linkInput" placeholder="Cole ou digite o link aqui">
        <div class="link-buttons">
            <button class="btn btn-secondary" id="cancelLinkBtn">Cancelar</button>
            <button class="btn btn-primary" id="saveLinkBtn">Salvar</button>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>

    <script type="module">
        // --- IMPORTS DO FIREBASE ---
        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            collection,
            getDocs,
            addDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDGUikGRoJoVu3g0tSenKtZHffflApUWQ",
            authDomain: "agenda-diaria-6c1ac.firebaseapp.com",
            projectId: "agenda-diaria-6c1ac",
            storageBucket: "agenda-diaria-6c1ac.firebasestorage.app",
            messagingSenderId: "38282868914",
            appId: "1:38282868914:web:a8332ed3fe258a41af71ab",
            measurementId: "G-3B5J0MLJ7R"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CLASSES ---
        class TranslationService {
            constructor() {
                this.cache = new Map();
            }

            async translateText(text, sourceLang = 'fr', targetLang = 'pt') {
                const cacheKey = `${text}-${sourceLang}-${targetLang}`;
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                try {
                    if ('translations' in window) {
                        const translation = await this.translateWithBrowserAPI(text, sourceLang, targetLang);
                        this.cache.set(cacheKey, translation);
                        return translation;
                    }
                    
                    const translation = await this.translateWithGoogleAPI(text, sourceLang, targetLang);
                    this.cache.set(cacheKey, translation);
                    return translation;
                    
                } catch (error) {
                    console.error('Erro na tradu√ß√£o:', error);
                    return `[Tradu√ß√£o indispon√≠vel: ${text}]`;
                }
            }

            async translateWithBrowserAPI(text, sourceLang, targetLang) {
                return new Promise((resolve, reject) => {
                    if (window.chrome && window.chrome.i18n) {
                        window.chrome.i18n.detectLanguage(text, (detection) => {
                            if (detection.isReliable) {
                                resolve(`[Tradu√ß√£o: ${text}]`);
                            } else {
                                reject(new Error('Tradu√ß√£o n√£o dispon√≠vel'));
                            }
                        });
                    } else {
                        reject(new Error('API de tradu√ß√£o n√£o dispon√≠vel'));
                    }
                });
            }

            async translateWithGoogleAPI(text, sourceLang, targetLang) {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Falha na tradu√ß√£o');
                }
                
                const data = await response.json();
                return data[0][0][0];
            }

            async translateWords(words) {
                const translations = {};
                for (const word of words) {
                    if (!translations[word]) {
                        translations[word] = await this.translateText(word);
                    }
                }
                return translations;
            }
        }

        class LinkService {
            constructor() {
                this.frasesLinksKey = 'frases_com_links';
                this.palavrasLinksKey = 'palavras_com_links';
            }

            hasLink(text, isPhrase) {
                const storageKey = isPhrase ? this.frasesLinksKey : this.palavrasLinksKey;
                const linksData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                return !!linksData[text];
            }

            getLink(text, isPhrase) {
                const storageKey = isPhrase ? this.frasesLinksKey : this.palavrasLinksKey;
                const linksData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                return linksData[text];
            }

            saveLink(text, link, isPhrase) {
                const storageKey = isPhrase ? this.frasesLinksKey : this.palavrasLinksKey;
                const linksData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                linksData[text] = link;
                localStorage.setItem(storageKey, JSON.stringify(linksData));
                return true;
            }

            openLink(text, isPhrase) {
                const link = this.getLink(text, isPhrase);
                if (link) {
                    window.open(link, '_blank');
                    return true;
                }
                return false;
            }
        }

        class AnkiService {
            constructor() {
                this.frasesCollection = "frases";
                this.palavrasCollection = "palavras";
            }

            async isSaved(text) {
                try {
                    const [frasesSnap, palavrasSnap] = await Promise.all([
                        getDocs(collection(db, this.frasesCollection)),
                        getDocs(collection(db, this.palavrasCollection))
                    ]);
                    
                    const existeNasFrases = frasesSnap.docs.some(doc => 
                        doc.data().texto.toLowerCase() === text.toLowerCase()
                    );
                    
                    const existeNasPalavras = palavrasSnap.docs.some(doc => 
                        doc.data().texto.toLowerCase() === text.toLowerCase()
                    );
                    
                    return existeNasFrases || existeNasPalavras;
                    
                } catch (error) {
                    console.error("Erro ao verificar item salvo:", error);
                    return false;
                }
            }

            async saveItem(text, type, translationService) {
                const isPhrase = text.split(/\s+/).length > 1;
                const collectionName = isPhrase ? this.frasesCollection : this.palavrasCollection;

                const jaSalvo = await this.isSaved(text);
                console.log(`Verificando "${text}":`, { jaSalvo, collectionName });
                
                if (jaSalvo) {
                    return { success: false, message: `"${text}" j√° est√° salvo no Anki!` };
                }

                const traducao = await translationService.translateText(text);

                const item = {
                    texto: text,
                    traducao: traducao,
                    tipo: isPhrase ? 'frase' : 'palavra',
                    data: new Date().toISOString(),
                    reviewData: {
                        nextReview: new Date().toISOString().split('T')[0],
                        interval: 1,
                        ease: 2.5,
                        reviews: 0
                    }
                };

                try {
                    console.log("Tentando salvar no Firebase:", { collectionName, item });
                    await addDoc(collection(db, collectionName), item);
                    console.log("Salvo com sucesso!");
                    return { success: true, message: `"${text}" salvo no Anki!` };
                } catch (error) {
                    console.error("Erro ao salvar no Firebase:", error);
                    return { success: false, message: "Erro ao salvar no Firebase" };
                }
            }

            async removeItem(text) {
                try {
                    const [frasesSnap, palavrasSnap] = await Promise.all([
                        getDocs(collection(db, this.frasesCollection)),
                        getDocs(collection(db, this.palavrasCollection))
                    ]);
                    
                    let docToDelete = null;
                    let collectionToDelete = null;
                    
                    frasesSnap.docs.forEach(doc => {
                        if (doc.data().texto.toLowerCase() === text.toLowerCase()) {
                            docToDelete = doc.id;
                            collectionToDelete = this.frasesCollection;
                        }
                    });
                    
                    if (!docToDelete) {
                        palavrasSnap.docs.forEach(doc => {
                            if (doc.data().texto.toLowerCase() === text.toLowerCase()) {
                                docToDelete = doc.id;
                                collectionToDelete = this.palavrasCollection;
                            }
                        });
                    }
                    
                    if (docToDelete) {
                        await deleteDoc(doc(db, collectionToDelete, docToDelete));
                        return { success: true, message: `"${text}" removido do Anki!` };
                    }
                    
                    return { success: false, message: "Item n√£o encontrado" };
                } catch (error) {
                    console.error("Erro ao remover do Firebase:", error);
                    return { success: false, message: "Erro ao remover do Firebase" };
                }
            }
        }

        // --- VARI√ÅVEIS GLOBAIS ---
        let selectedText = '';
        let currentPhrase = '';
        let currentType = '';

        // --- FUN√á√ïES PRINCIPAIS ---
        async function carregarTextoFirebase() {
            const docId = "05112025";
            const docRef = doc(db, "Openbible", docId);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    const texto = dados.texto || "(sem texto encontrado)";
                    document.getElementById('textContent').textContent = texto;
                    console.log("Texto carregado do Firebase:", texto);
                    
                    await loadAndHighlightText();
                } else {
                    console.warn("Documento 05112025 n√£o encontrado.");
                    document.getElementById('textContent').textContent = "(documento 05112025 n√£o encontrado)";
                }
            } catch (e) {
                console.error("Erro ao carregar texto:", e);
                document.getElementById('textContent').textContent = "(erro ao carregar texto)";
            }
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        async function loadAndHighlightText() {
            const originalText = document.getElementById('textContent').textContent;
            
            try {
                const [frasesSnap, palavrasSnap] = await Promise.all([
                    getDocs(collection(db, "frases")),
                    getDocs(collection(db, "palavras"))
                ]);
                
                const frases = frasesSnap.docs.map(doc => ({...doc.data(), id: doc.id}));
                const palavras = palavrasSnap.docs.map(doc => ({...doc.data(), id: doc.id}));
                
                console.log('Frases salvas:', frases.map(f => f.texto));
                console.log('Palavras salvas:', palavras.map(p => p.texto));
                
                let highlightedText = originalText;
                let fraseSpans = [];
                
                // FASE 1: Destacar frases primeiro
                frases.forEach(frase => {
                    const textoFrase = frase.texto;
                    if (originalText.toLowerCase().includes(textoFrase.toLowerCase())) {
                        const regex = new RegExp(escapeRegExp(textoFrase), 'gi');
                        highlightedText = highlightedText.replace(regex, (match) => {
                            const spanId = `frase-${frase.id}`;
                            const startIndex = highlightedText.indexOf(match);
                            const endIndex = startIndex + match.length;
                            
                            fraseSpans.push({
                                id: spanId,
                                text: match,
                                start: startIndex,
                                end: endIndex
                            });
                            
                            return `<span class="highlighted saved-phrase" id="${spanId}" title="Frase salva - Clique para ver detalhes" onclick="window.showSavedItem('${frase.id}', 'frase')">${match}</span>`;
                        });
                    }
                });
                
                // FASE 2: Destacar palavras individuais
                palavras.forEach(palavra => {
                    const textoPalavra = palavra.texto;
                    const regex = new RegExp(`\\b${escapeRegExp(textoPalavra)}\\b`, 'gi');
                    
                    let lastIndex = 0;
                    let newText = '';
                    let match;
                    
                    while ((match = regex.exec(highlightedText)) !== null) {
                        const matchText = match[0];
                        const matchStart = match.index;
                        const matchEnd = matchStart + matchText.length;
                        
                        const isInsideFrase = fraseSpans.some(fraseSpan => 
                            matchStart >= fraseSpan.start && matchEnd <= fraseSpan.end
                        );
                        
                        newText += highlightedText.substring(lastIndex, matchStart);
                        
                        if (!isInsideFrase) {
                            newText += `<span class="highlighted saved-word" title="Palavra salva - Clique para ver detalhes" onclick="window.showSavedItem('${palavra.id}', 'palavra')">${matchText}</span>`;
                        } else {
                            newText += matchText;
                        }
                        
                        lastIndex = matchEnd;
                    }
                    
                    newText += highlightedText.substring(lastIndex);
                    highlightedText = newText;
                });
                
                document.getElementById('textContent').innerHTML = highlightedText;
                
            } catch (error) {
                console.error("Erro ao carregar dados do Firebase:", error);
                document.getElementById('textContent').innerHTML = originalText;
            }
        }

// --- FUN√á√ïES GLOBAIS ---
window.showSavedItem = async function(id, tipo) {
    try {
        const docRef = doc(db, tipo === 'frase' ? "frases" : "palavras", id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const item = docSnap.data();
            // Usar a vari√°vel global selectedText
            window.selectedText = item.texto;
            // Chamar a fun√ß√£o global showTranslationModal
            if (window.showTranslationModal) {
                window.showTranslationModal();
            } else {
                console.error("showTranslationModal n√£o est√° dispon√≠vel");
            }
        }
    } catch (error) {
        console.error("Erro ao carregar item:", error);
    }
};

// Tornar a fun√ß√£o showTranslationModal global
window.showTranslationModal = async function() {
    const fullTranslationText = document.getElementById('fullTranslationText');
    const wordTranslations = document.getElementById('wordTranslations');
    const phraseActions = document.getElementById('phraseActions');
    const translationModal = document.getElementById('translationModal');
    const overlay = document.getElementById('overlay');
    
    fullTranslationText.innerHTML = '<div class="loading">Carregando tradu√ß√£o...</div>';
    wordTranslations.innerHTML = '<div class="loading">Carregando tradu√ß√µes individuais...</div>';
    phraseActions.innerHTML = '';
    
    const selected = window.selectedText.trim();
    const isSingleWord = selected.split(/\s+/).length === 1;
    
    try {
        const translationService = new TranslationService();
        
        if (isSingleWord) {
            const translation = await translationService.translateText(selected);
            
            fullTranslationText.innerHTML = `
                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>"${selected}"</strong> ‚Üí "${translation}"
                    </div>
                </div>
            `;
            
            const actionButtons = await createGlobalActionButtons(selected, 'word');
            phraseActions.appendChild(actionButtons);
            
            wordTranslations.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 10px;">(Palavra √∫nica selecionada)</div>';
        } else {
            const phraseTranslation = await translationService.translateText(selected);
            
            fullTranslationText.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>"${selected}"</strong> ‚Üí "${phraseTranslation}"
                </div>
            `;
            
            const actionButtons = await createGlobalActionButtons(selected, 'phrase');
            phraseActions.appendChild(actionButtons);
            
            const words = selected.split(/\s+/);
            const wordTranslationsMap = await translationService.translateWords(words);
            
            wordTranslations.innerHTML = '';
            for (const word of words) {
                const translation = wordTranslationsMap[word] || '(tradu√ß√£o n√£o dispon√≠vel)';
                
                const wordElement = document.createElement('div');
                wordElement.className = 'word-item';
                
                const wordContent = document.createElement('div');
                wordContent.style.display = 'flex';
                wordContent.style.justifyContent = 'space-between';
                wordContent.style.alignItems = 'center';
                wordContent.style.width = '100%';
                
                const textContent = document.createElement('div');
                textContent.style.display = 'flex';
                textContent.style.flex = '1';
                textContent.style.justifyContent = 'space-between';
                
                const originalSpan = document.createElement('span');
                originalSpan.className = 'original-word';
                originalSpan.textContent = word;
                
                const translatedSpan = document.createElement('span');
                translatedSpan.className = 'translated-word';
                translatedSpan.textContent = translation;
                
                textContent.appendChild(originalSpan);
                textContent.appendChild(translatedSpan);
                
                const actions = await createGlobalActionButtons(word, 'word');
                
                wordContent.appendChild(textContent);
                wordContent.appendChild(actions);
                
                wordElement.appendChild(wordContent);
                wordTranslations.appendChild(wordElement);
            }
        }
    } catch (error) {
        console.error('Erro ao carregar tradu√ß√µes:', error);
        fullTranslationText.innerHTML = '<div class="error">Erro ao carregar tradu√ß√£o. Tente novamente.</div>';
        wordTranslations.innerHTML = '<div class="error">Erro ao carregar tradu√ß√µes individuais.</div>';
    }
    
    translationModal.style.display = 'block';
    overlay.style.display = 'block';
};

// Fun√ß√£o global para criar bot√µes de a√ß√£o
async function createGlobalActionButtons(text, type) {
    const container = document.createElement('div');
    container.className = type === 'phrase' ? 'phrase-actions' : 'word-actions';
    
    const ankiService = new AnkiService();
    const linkService = new LinkService();
    
    // Bot√£o de √°udio
    const audioBtn = document.createElement('button');
    audioBtn.className = 'action-button';
    audioBtn.innerHTML = 'üîä';
    audioBtn.title = 'Ouvir pron√∫ncia';
    audioBtn.onclick = () => {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        } else {
            alert('Seu navegador n√£o suporta s√≠ntese de voz.');
        }
    };
    
    // Verificar se j√° est√° salvo no Anki
    const isSaved = await ankiService.isSaved(text);
    
    // Bot√£o de salvamento condicional
    const saveBtn = document.createElement('button');
    saveBtn.className = 'action-button';
    
    if (isSaved) {
        saveBtn.innerHTML = 'üíø';
        saveBtn.title = 'J√° salvo no Anki';
        saveBtn.onclick = async () => {
            if (confirm(`"${text}" j√° est√° salvo no Anki. Deseja remov√™-lo?`)) {
                const result = await ankiService.removeItem(text);
                alert(result.message);
                window.showTranslationModal();
                // Recarregar os destaques
                if (window.loadAndHighlightText) {
                    await window.loadAndHighlightText();
                }
            }
        };
    } else {
        saveBtn.innerHTML = 'üíæ';
        saveBtn.title = 'Salvar no Anki';
        saveBtn.onclick = async () => {
            const translationService = new TranslationService();
            const result = await ankiService.saveItem(text, type, translationService);
            alert(result.message);
            
            if (result.success) {
                // Recarregar os destaques
                if (window.loadAndHighlightText) {
                    await window.loadAndHighlightText();
                }
                window.showTranslationModal();
            }
        };
    }
    
    const isPhrase = type === 'phrase';
    const hasLink = linkService.hasLink(text, isPhrase);
    
    const linkBtn = document.createElement('button');
    linkBtn.className = 'action-button';
    
    if (hasLink) {
        linkBtn.innerHTML = 'üìö';
        linkBtn.title = 'Abrir link cadastrado';
        linkBtn.onclick = () => linkService.openLink(text, isPhrase);
    } else {
        linkBtn.innerHTML = '‚öì';
        linkBtn.title = 'Cadastrar link';
        linkBtn.onclick = () => {
            // Abrir modal de link (implementa√ß√£o b√°sica)
            const link = prompt(`Digite o link para "${text}":`);
            if (link) {
                linkService.saveLink(text, link, isPhrase);
                alert(`Link salvo para "${text}"!`);
                // Recriar os bot√µes para refletir a mudan√ßa
                window.showTranslationModal();
            }
        };
    }
    
    container.appendChild(audioBtn);
    container.appendChild(saveBtn);
    container.appendChild(linkBtn);
    
    return container;
}

// Tornar a fun√ß√£o loadAndHighlightText global
window.loadAndHighlightText = loadAndHighlightText;

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', function() {
            const textContent = document.getElementById('textContent');
            const translateBtn = document.getElementById('translateBtn');
            const translationModal = document.getElementById('translationModal');
            const closeModal = document.getElementById('closeModal');
            const fullTranslationText = document.getElementById('fullTranslationText');
            const wordTranslations = document.getElementById('wordTranslations');
            const phraseActions = document.getElementById('phraseActions');
            const overlay = document.getElementById('overlay');
            const linkModal = document.getElementById('linkModal');
            const linkInput = document.getElementById('linkInput');
            const cancelLinkBtn = document.getElementById('cancelLinkBtn');
            const saveLinkBtn = document.getElementById('saveLinkBtn');
            
            // Inicializar servi√ßos
            const translationService = new TranslationService();
            const linkService = new LinkService();
            const ankiService = new AnkiService();

            function showFloatingButton(x, y) {
                translateBtn.style.display = 'block';
                translateBtn.style.left = (x - 60) + 'px';
                translateBtn.style.top = (y - 50) + 'px';
            }
            
            function hideFloatingButton() {
                translateBtn.style.display = 'none';
            }
            
            async function createActionButtons(text, type) {
                const container = document.createElement('div');
                container.className = type === 'phrase' ? 'phrase-actions' : 'word-actions';
                
                // Bot√£o de √°udio
                const audioBtn = document.createElement('button');
                audioBtn.className = 'action-button';
                audioBtn.innerHTML = 'üîä';
                audioBtn.title = 'Ouvir pron√∫ncia';
                audioBtn.onclick = () => speakText(text);
                
                // Verificar se j√° est√° salvo no Anki
                const isSaved = await ankiService.isSaved(text);
                
                // Bot√£o de salvamento condicional
                const saveBtn = document.createElement('button');
                saveBtn.className = 'action-button';
                
                if (isSaved) {
                    saveBtn.innerHTML = 'üíø';
                    saveBtn.title = 'J√° salvo no Anki';
                    saveBtn.onclick = async () => {
                        if (confirm(`"${text}" j√° est√° salvo no Anki. Deseja remov√™-lo?`)) {
                            const result = await ankiService.removeItem(text);
                            alert(result.message);
                            showTranslationModal();
                            loadAndHighlightText();
                        }
                    };
                } else {
                    saveBtn.innerHTML = 'üíæ';
                    saveBtn.title = 'Salvar no Anki';
                    saveBtn.onclick = () => saveToAnki(text, type);
                }
                
                const isPhrase = type === 'phrase';
                const hasLink = linkService.hasLink(text, isPhrase);
                
                const linkBtn = document.createElement('button');
                linkBtn.className = 'action-button';
                
                if (hasLink) {
                    linkBtn.innerHTML = 'üìö';
                    linkBtn.title = 'Abrir link cadastrado';
                    linkBtn.onclick = () => linkService.openLink(text, isPhrase);
                } else {
                    linkBtn.innerHTML = '‚öì';
                    linkBtn.title = 'Cadastrar link';
                    linkBtn.onclick = () => openLinkModal(text, type);
                }
                
                container.appendChild(audioBtn);
                container.appendChild(saveBtn);
                container.appendChild(linkBtn);
                
                return container;
            }
            
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'fr-FR';
                    utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Seu navegador n√£o suporta s√≠ntese de voz.');
                }
            }
            
            async function saveToAnki(text, type) {
                const result = await ankiService.saveItem(text, type, translationService);
                alert(result.message);
                
                if (result.success) {
                    loadAndHighlightText();
                    showTranslationModal();
                }
            }
            
            function openLinkModal(text, type) {
                currentPhrase = text;
                currentType = type;
                linkInput.value = '';
                linkModal.style.display = 'block';
                overlay.style.display = 'block';
            }
            
            function saveLink() {
                const link = linkInput.value.trim();
                if (link) {
                    const isPhrase = currentType === 'phrase';
                    
                    if (linkService.saveLink(currentPhrase, link, isPhrase)) {
                        alert(`Link salvo para "${currentPhrase}"!`);
                        closeLinkModal();
                        
                        if (selectedText === currentPhrase) {
                            showTranslationModal();
                        }
                    }
                } else {
                    alert('Por favor, insira um link v√°lido.');
                }
            }
            
            function closeLinkModal() {
                linkModal.style.display = 'none';
                overlay.style.display = 'none';
            }
            
            async function showTranslationModal() {
                fullTranslationText.innerHTML = '<div class="loading">Carregando tradu√ß√£o...</div>';
                wordTranslations.innerHTML = '<div class="loading">Carregando tradu√ß√µes individuais...</div>';
                phraseActions.innerHTML = '';
                
                const selected = selectedText.trim();
                const isSingleWord = selected.split(/\s+/).length === 1;
                
                try {
                    if (isSingleWord) {
                        const translation = await translationService.translateText(selected);
                        
                        fullTranslationText.innerHTML = `
                            <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>"${selected}"</strong> ‚Üí "${translation}"
                                </div>
                            </div>
                        `;
                        
                        const actionButtons = await createActionButtons(selected, 'word');
                        phraseActions.appendChild(actionButtons);
                        
                        wordTranslations.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 10px;">(Palavra √∫nica selecionada)</div>';
                    } else {
                        const phraseTranslation = await translationService.translateText(selected);
                        
                        fullTranslationText.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                <strong>"${selected}"</strong> ‚Üí "${phraseTranslation}"
                            </div>
                        `;
                        
                        const actionButtons = await createActionButtons(selected, 'phrase');
                        phraseActions.appendChild(actionButtons);
                        
                        const words = selected.split(/\s+/);
                        const wordTranslationsMap = await translationService.translateWords(words);
                        
                        wordTranslations.innerHTML = '';
                        for (const word of words) {
                            const translation = wordTranslationsMap[word] || '(tradu√ß√£o n√£o dispon√≠vel)';
                            
                            const wordElement = document.createElement('div');
                            wordElement.className = 'word-item';
                            
                            const wordContent = document.createElement('div');
                            wordContent.style.display = 'flex';
                            wordContent.style.justifyContent = 'space-between';
                            wordContent.style.alignItems = 'center';
                            wordContent.style.width = '100%';
                            
                            const textContent = document.createElement('div');
                            textContent.style.display = 'flex';
                            textContent.style.flex = '1';
                            textContent.style.justifyContent = 'space-between';
                            
                            const originalSpan = document.createElement('span');
                            originalSpan.className = 'original-word';
                            originalSpan.textContent = word;
                            
                            const translatedSpan = document.createElement('span');
                            translatedSpan.className = 'translated-word';
                            translatedSpan.textContent = translation;
                            
                            textContent.appendChild(originalSpan);
                            textContent.appendChild(translatedSpan);
                            
                            const actions = await createActionButtons(word, 'word');
                            
                            wordContent.appendChild(textContent);
                            wordContent.appendChild(actions);
                            
                            wordElement.appendChild(wordContent);
                            wordTranslations.appendChild(wordElement);
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar tradu√ß√µes:', error);
                    fullTranslationText.innerHTML = '<div class="error">Erro ao carregar tradu√ß√£o. Tente novamente.</div>';
                    wordTranslations.innerHTML = '<div class="error">Erro ao carregar tradu√ß√µes individuais.</div>';
                }
                
                translationModal.style.display = 'block';
                overlay.style.display = 'block';
            }
            
            function closeTranslationModal() {
                translationModal.style.display = 'none';
                overlay.style.display = 'none';
            }
            
            // Event Listeners
            document.addEventListener('mouseup', function(e) {
                if (e.target.classList.contains('highlighted')) {
                    return;
                }
                
                selectedText = window.getSelection().toString().trim();
                
                if (selectedText.length > 0) {
                    showFloatingButton(e.pageX, e.pageY);
                } else {
                    hideFloatingButton();
                }
            });
            
            translateBtn.addEventListener('click', function() {
                showTranslationModal();
                hideFloatingButton();
            });
            
            closeModal.addEventListener('click', closeTranslationModal);
            overlay.addEventListener('click', closeTranslationModal);
            
            cancelLinkBtn.addEventListener('click', closeLinkModal);
            saveLinkBtn.addEventListener('click', saveLink);
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTranslationModal();
                    closeLinkModal();
                }
            });

            // Carregar texto inicial
            carregarTextoFirebase();
        });
    </script>
</body>
</html>